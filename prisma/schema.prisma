generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum Status {
  ACTIVE
  INACTIVE
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  role          UserRole @default(EMPLOYEE)

  sessions Session[]
  accounts Account[]

  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  companyId    String?
  company      Company?    @relation(fields: [companyId], references: [id])
  branchId     String?
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  employee     Employee?
  inviteTokens InviteToken[]

  jobTitles JobTitle[]

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  @@map("sessions")
}

model Account {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  @@map("accounts")
}

model Verification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model Company {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  logo      String?
  vatNumber String?
  crNumber  String?
  phone     String?
  email     String?
  website   String?
  address   String?

  users    User[]
  branches Branch[]

  @@map("companies")
}

model Branch {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name    String
  address String?
  phone   String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  departments Department[]
  users       User[]

  @@map("branches")
}

model Department {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name String

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  users User[]

  @@map("departments")
}

model Employee {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image         String?
  phone         String?
  gender        String?
  nationality   String?
  dateOfBirth   DateTime?
  maritalStatus String?
  address       String?

  emergencyName     String?
  emergencyPhone    String?
  emergencyRelation String?

  iqamaNo        String?
  iqamaExpiry    DateTime?
  passportNo     String?
  passportExpiry DateTime?

  empId            String?
  jobTitle         String?
  employmentType   String? // Full-time, Part-time, Contract
  joinDate         DateTime?
  contractValidity String? // in months
  probationPeriod  String? // in months
  workingHours     String?
  workingDays      String?
  workLocation     String?

  bankName    String?
  bankAccount String?
  bankIBAN    String?

  basicSalary             Float?
  housingAllowance        Float?
  transportationAllowance Float?
  foodAllowance           Float?
  mobileAllowance         Float?
  otherAllowance          Float?

  insuranceName       String?
  insuranceCategory   String? // e.g., Health, Dental, Vision
  insuranceIssueDate  DateTime?
  insuranceExpiryDate DateTime?

  status String? // Active, Terminated, etc.

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employees")
}

model InviteToken {
  id        String   @id @default(uuid())
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model OrgNode {
  id         String    @id @default(uuid())
  employeeId String? // optional: empty node when no employee assigned yet
  parentId   String? // self relation
  parent     OrgNode?  @relation("OrgNodeHierarchy", fields: [parentId], references: [id])
  children   OrgNode[] @relation("OrgNodeHierarchy")
  createdAt  DateTime  @default(now())

  @@map("org_nodes")
}

model JobTitle {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name   String
  status Status @default(ACTIVE)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@map("jobtitles")
}
