generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String                   @id @default(uuid())
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @default(now()) @updatedAt
  name          String
  email         String                   @unique
  emailVerified Boolean                  @default(false)
  role          UserRole                 @default(EMPLOYEE)
  banned        Boolean?                 @default(false)
  banReason     String?
  banExpires    DateTime?
  companyId     String?
  inviteTokens  InviteToken[]
  notifications Notification[]
  preferences   NotificationPreference[]
  accounts      Account[]
  employee      Employee?
  jobTitles     JobTitle[]
  sessions      Session[]
  company       Company?                 @relation(fields: [companyId], references: [id])

  @@map("users")
}

model Session {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  userId         String
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(uuid())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model Company {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  logo      String?
  vatNumber String?
  crNumber  String?
  phone     String?
  email     String?
  website   String?
  address   String?
  branches  Branch[]
  users     User[]

  @@map("companies")
}

model Branch {
  id           String        @id @default(uuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  name         String
  address      String?
  phone        String?
  companyId    String
  geoFences    GeoFence[]
  holidays     Holiday[]
  weekendRules WeekendRule[]
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  departments  Department[]

  @@map("branches")
}

model Department {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  name      String
  branchId  String
  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  employees Employee[]

  @@map("departments")
}

model Employee {
  id                      String             @id @default(uuid())
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  empId                   String?            @unique
  image                   String?
  phone                   String?
  gender                  String?
  nationality             String?
  dateOfBirth             DateTime?
  maritalStatus           String?
  address                 String?
  emergencyName           String?
  emergencyPhone          String?
  emergencyRelation       String?
  iqamaNo                 String?
  iqamaExpiry             DateTime?
  passportNo              String?
  passportExpiry          DateTime?
  jobTitle                String?
  joinDate                DateTime?
  basicSalary             Float?
  userId                  String             @unique
  bankAccount             String?
  bankIBAN                String?
  bankName                String?
  contractValidity        String?
  departmentId            String
  employmentType          String?
  foodAllowance           Float?
  housingAllowance        Float?
  insuranceCategory       String?
  insuranceExpiryDate     DateTime?
  insuranceIssueDate      DateTime?
  insuranceName           String?
  managerId               String?
  mobileAllowance         Float?
  otherAllowance          Float?
  probationPeriod         String?
  shiftId                 String?
  transportationAllowance Float?
  workLocation            String?
  workingDays             String?
  workingHours            String?
  status                  Status             @default(ACTIVE)
  assets                  Asset[]
  attendance              Attendance[]
  documents               EmployeeDocument[]
  leaveBalance            LeaveBalance[]
  leaves                  LeaveRequest[]
  overtimes               Overtime[]
  payrolls                Payroll[]
  salaryHistory           SalaryHistory[]
  department              Department         @relation(fields: [departmentId], references: [id])
  manager                 Employee?          @relation("Manager", fields: [managerId], references: [id])
  team                    Employee[]         @relation("Manager")
  shift                   Shift?             @relation(fields: [shiftId], references: [id])
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employees")
}

model InviteToken {
  id        String   @id @default(uuid())
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model JobTitle {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  createdById String
  status      Status   @default(ACTIVE)
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@map("jobtitles")
}

model Shift {
  id        String     @id @default(cuid())
  name      String
  startTime DateTime
  endTime   DateTime
  graceMin  Int
  employees Employee[]
}

model Attendance {
  id              String           @id @default(cuid())
  employeeId      String
  date            DateTime
  checkIn         DateTime?
  checkOut        DateTime?
  lat             Float?
  lng             Float?
  status          AttendanceStatus
  workedMinutes   Int?
  overtimeMinutes Int?
  employee        Employee         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
}

model GeoFence {
  id        String @id @default(cuid())
  branchId  String
  latitude  Float
  longitude Float
  radiusM   Int
  branch    Branch @relation(fields: [branchId], references: [id])
}

model WeekendRule {
  id       String  @id @default(cuid())
  branchId String
  day      WeekDay
  isOff    Boolean @default(true)
  branch   Branch  @relation(fields: [branchId], references: [id])

  @@unique([branchId, day])
}

model Holiday {
  id        String   @id @default(cuid())
  title     String
  date      DateTime
  branchId  String?
  createdAt DateTime @default(now())
  branch    Branch?  @relation(fields: [branchId], references: [id])
}

model LeaveType {
  id            String         @id @default(cuid())
  name          String
  maxPerYear    Int
  paid          Boolean
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]
}

model LeaveBalance {
  id          String    @id @default(cuid())
  employeeId  String
  leaveTypeId String
  year        Int
  balance     Int
  employee    Employee  @relation(fields: [employeeId], references: [id])
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
}

model LeaveRequest {
  id          String      @id @default(cuid())
  employeeId  String
  leaveTypeId String
  fromDate    DateTime
  toDate      DateTime
  reason      String
  status      LeaveStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  approvals   Approval[]
  employee    Employee    @relation(fields: [employeeId], references: [id])
  leaveType   LeaveType   @relation(fields: [leaveTypeId], references: [id])
}

model Overtime {
  id         String     @id @default(cuid())
  employeeId String
  date       DateTime
  hours      Float
  approved   Boolean    @default(false)
  approvals  Approval[]
  employee   Employee   @relation(fields: [employeeId], references: [id])
}

model Payroll {
  id          String   @id @default(cuid())
  employeeId  String
  month       Int
  year        Int
  baseSalary  Float
  overtimePay Float
  deductions  Float
  netSalary   Float
  employee    Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
}

model SalaryHistory {
  id            String   @id @default(cuid())
  employeeId    String
  salary        Float
  effectiveFrom DateTime
  reason        String?
  employee      Employee @relation(fields: [employeeId], references: [id])
}

model Asset {
  id         String      @id @default(cuid())
  name       String
  serialNo   String      @unique
  status     AssetStatus
  employeeId String?
  assignedAt DateTime?
  returnedAt DateTime?
  employee   Employee?   @relation(fields: [employeeId], references: [id])
}

model EmployeeDocument {
  id         String       @id @default(cuid())
  employeeId String
  type       DocumentType
  fileName   String
  fileUrl    String
  expiryDate DateTime?
  notified   Boolean      @default(false)
  uploadedAt DateTime     @default(now())
  employee   Employee     @relation(fields: [employeeId], references: [id])
}

model Approval {
  id             String        @id @default(cuid())
  type           ApprovalType
  refId          String
  level          ApprovalLevel
  approverId     String
  status         LeaveStatus
  comments       String?
  createdAt      DateTime      @default(now())
  leaveRequestId String?
  overtimeId     String?
  leaveRequest   LeaveRequest? @relation(fields: [leaveRequestId], references: [id])
  overtime       Overtime?     @relation(fields: [overtimeId], references: [id])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  refId     String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])
}

model NotificationPreference {
  id       String           @id @default(cuid())
  userId   String
  type     NotificationType
  viaPush  Boolean          @default(true)
  viaEmail Boolean          @default(false)
  viaInApp Boolean          @default(true)
  user     User             @relation(fields: [userId], references: [id])

  @@unique([userId, type])
}

enum UserRole {
  ADMIN
  HR
  EMPLOYEE
}

enum Status {
  ACTIVE
  INACTIVE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AssetStatus {
  ASSIGNED
  RETURNED
}

enum ApprovalType {
  LEAVE
  OVERTIME
  ASSET
}

enum ApprovalLevel {
  MANAGER
  HR
  ADMIN
}

enum WeekDay {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum DocumentType {
  ID
  PASSPORT
  CONTRACT
  CERTIFICATE
  OTHER
}

enum NotificationType {
  APPROVAL
  DOCUMENT_EXPIRY
  ATTENDANCE
  PAYROLL
  SYSTEM
}
